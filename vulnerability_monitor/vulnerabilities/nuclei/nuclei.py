from vulnerability_monitor.models import *
import subprocess , os , time
from url_monitor.tasks import sendmessage


OUTPUT_PATH = f'vulnerability_monitor/outputs'
template_path = os.path.expanduser("~/nuclei-templates")
os.makedirs(OUTPUT_PATH, exist_ok=True)


def clear_labels(self):
    XSSReport.objects.all().update(label="available")


def Nuclei(self):

    sendmessage(f"[INFO] Starting Nuclei Check on Subdomains HTTPX Result" , colour='CYAN' , telegram=True)
    
    def update_nuclei (self):
        result = subprocess.run(
            ['nuclei','-update','-ut','-silent'],
            shell=False,
            check=True,
        )
    def save_nuclei_output_from_file (nuclei_output , subdomain):
        print(nuclei_output)
        print(subdomain)
    
    def run_nuclei (subdomain , subdomain_httpx):
        command = [
            'nuclei',
            '-u', subdomain_httpx,
            '-t', template_path,
            '-severity','low,medium,high,critical',
            '-rate-limit', '150',
            '-json-export', f'{OUTPUT_PATH}/nuclei_result.json',
            '-silent',
            '-duc',
        ]
        try:
            result = subprocess.run(
                command,
                check=True,
                capture_output=True,
                text=True
            )
            save_nuclei_output_from_file(f"{OUTPUT_PATH}/nuclei_result.json" , subdomain)
            time.sleep(10)

        except subprocess.CalledProcessError as e:
            sendmessage(f"[ERROR] Nuclei execution failed: {e} on {subdomain_httpx}" , telegram=True)

    subdomains = SubdomainHttpx.objects.order_by('-label')
    update_nuclei(self)
    # clear_labels(self)

    for subdomain in subdomains :
        run_nuclei(subdomain , subdomain.httpx_result)

    