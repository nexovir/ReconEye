from vulnerability_monitor.models import NucleiReport, SubdomainHttpx
import subprocess, os, json
from programs_monitor.tasks import sendmessage
from django.utils.dateparse import parse_datetime
from datetime import datetime
from django.utils import timezone



OUTPUT_PATH = "vulnerability_monitor/vulnerabilities/nuclei/outputs"
TEMPLATE_PATH = os.path.expanduser("~/nuclei-templates")

def clear_labels():
    NucleiReport.objects.all().update(label="available")


def Nuclei(self, label):
    sendmessage("[vulnerability_monitor] ℹ️ Starting Nuclei Check on Subdomains HTTPX Results",
                colour="CYAN", telegram=True)

    def update_nuclei():
        try:
            sendmessage(f"[Vulnerability_Monitor] ℹ️ Start Updating Nuclei & Nuclei Templates")
            subprocess.run(["nuclei", "-update", "-ut", "-silent"], check=True)
        except subprocess.CalledProcessError as e:
            sendmessage(f"[vulnerability_monitor] ❌ Nuclei update failed: {e}", telegram=True)



    def save_nuclei_output_from_file(nuclei_output, subdomain_obj):

        try:
            with open(nuclei_output, "r", encoding="utf-8") as f:
                content = f.read().strip()
        except Exception as e:
            return

        items = []
        try:
            data = json.loads(content)
            if isinstance(data, dict):
                items = [data]
            elif isinstance(data, list):
                items = data
        except json.JSONDecodeError:
            for line in content.splitlines():
                try:
                    items.append(json.loads(line.strip()))
                except Exception:
                    continue

        for item in items:
            try:
                template_id = item.get("templateID") or "unknown"
                template_name = item.get("templateName") or "unknown"
                severity = item.get("info", {}).get("severity") or "info"
                tags = item.get("info", {}).get("tags")
                vuln_type = item.get("info", {}).get("type") or item.get("type")
                host = item.get("host") or subdomain_obj.domain
                port = str(item.get("port") or "")
                matched_at = item.get("matched-at") or ""
                extracted_results = json.dumps(item.get("extracted-results", []))
                ip = item.get("ip") or "0.0.0.0"

                ts_raw = item.get("timestamp")
                if ts_raw:
                    try:
                        timestamp = datetime.fromisoformat(ts_raw.replace("Z", "+00:00"))
                    except Exception:
                        timestamp = timezone.now()
                else:
                    timestamp = timezone.now()

                NucleiReport.objects.create(
                    asset=subdomain_obj,
                    template_id=template_id,
                    template_name=template_name,
                    severity=severity,
                    tags=tags,
                    type=vuln_type,
                    host=host,
                    port=port,
                    matched_at=matched_at,
                    extracted_results=extracted_results,
                    ip=ip,
                    timestamp=timestamp,
                )

            except Exception as e:
                sendmessage(f"[Vulnerability_Monitor] ❌ Error saving item: {e}")



    def run_nuclei(subdomain_obj, subdomain_httpx):
        sendmessage(f"[Vulnerability_Monitor] ℹ️ Starting Nuclei on {subdomain_httpx}")
        output_file = os.path.join(OUTPUT_PATH, "nuclei_result.json")

        tags = "cve,panel,exposure,osint,rce,lfi"
        if "wordpress" in subdomain_obj.technologies.lower():
            tags += ",wp-plugin,wordpress"

        command = [
            "nuclei",
            "-u", subdomain_httpx,
            "-t", TEMPLATE_PATH,
            "-tags", tags,
            "-rate-limit", "150",
            "-json-export", output_file,
            "-silent",
            "-duc",
        ]

        result = subprocess.run(command, capture_output=True, text=True)
        save_nuclei_output_from_file(output_file, subdomain_obj)

    update_nuclei()
    clear_labels()
    subdomains = SubdomainHttpx.objects.filter(label=label)

    for subdomain in subdomains:
        run_nuclei(subdomain, subdomain.httpx_result)

