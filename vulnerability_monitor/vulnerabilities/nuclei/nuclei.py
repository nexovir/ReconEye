from vulnerability_monitor.models import NucleiReport, SubdomainHttpx
import subprocess, os, json
from programs_monitor.tasks import sendmessage
from django.utils.dateparse import parse_datetime


OUTPUT_PATH = "vulnerability_monitor/vulnerabilities/nuclei/outputs"
TEMPLATE_PATH = os.path.expanduser("~/nuclei-templates")
os.makedirs(OUTPUT_PATH, exist_ok=True)


def clear_labels():
    NucleiReport.objects.all().update(label="available")


def Nuclei(self, label):
    sendmessage("[INFO] Starting Nuclei Check on Subdomains HTTPX Results", colour="CYAN", telegram=True)

    def update_nuclei():
        try:
            subprocess.run(["sudo", "nuclei", "-update", "-ut", "-silent"], check=True)
        except subprocess.CalledProcessError as e:
            sendmessage(f"[ERROR] Nuclei update failed: {e}", telegram=True)

    def save_nuclei_output_from_file(nuclei_output, subdomain_obj):
        print(nuclei_output)
        if not os.path.exists(nuclei_output):
            return

        with open(nuclei_output, "r", encoding="utf-8") as f:
            for line in f:
                try:
                    data = json.loads(line.strip())
                except Exception:
                    continue

                if isinstance(data, list):
                    items = data
                else:
                    items = [data]

                for item in items:
                    template_id = item.get("templateID")
                    host = item.get("host")

                    if not template_id or not host:
                        continue

                    exists = NucleiReport.objects.filter(
                        template_id=template_id, host=host
                    ).exists()

                    if not exists:
                        NucleiReport.objects.create(
                            asset=subdomain_obj,
                            template_id=str(item.get("templateID", "")),
                            template_name=str(item.get("templateName", "")),
                            severity=str(item.get("info", {}).get("severity", "")),
                            tags=str(item.get("info", {}).get("tags", "")),
                            type=str(item.get("info", {}).get("type", "")),
                            host=str(item.get("host", "")),
                            port=str(item.get("port", "")),
                            matched_at=str(item.get("matched-at", "")),
                            extracted_results=item.get("extracted-results", []),
                            ip=str(item.get("ip", "")),
                            timestamp=parse_datetime(item.get("timestamp", "")) if item.get("timestamp") else None,
                        )

        os.remove(nuclei_output)

    def run_nuclei(subdomain_obj, subdomain_httpx):
        output_file = f"{OUTPUT_PATH}/nuclei_result.json"

        command = [
            "nuclei",
            "-u", subdomain_httpx,
            "-t", TEMPLATE_PATH,
            "-p", "socks5://127.0.0.1:1080",
            "-tags", "ve,panel,exposure,osint,rce,lf",
            "-rate-limit", "150",
            "-json-export", output_file,
            "-silent",
            "-duc",
        ]

        try:
            subprocess.run(command, check=True, capture_output=True, text=True)
            save_nuclei_output_from_file(output_file, subdomain_obj)
        except subprocess.CalledProcessError as e:
            sendmessage(f"[ERROR] Nuclei execution failed: {e} on {subdomain_httpx}", telegram=True)

    # update_nuclei() 
    clear_labels()
    subdomains = SubdomainHttpx.objects.filter(label=label)

    for subdomain in subdomains:
        run_nuclei(subdomain, subdomain.httpx_result)
